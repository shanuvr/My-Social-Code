openapi: 3.0.0
info:
  title: MySocialCode API
  description: Real-world social experiences - safe, small-group events that build belonging
  version: 1.0.0
  contact:
    name: MySocialCode Support
    email: support@mysocialcode.com

servers:
  - url: http://localhost:3000/api
    description: Local development
  - url: https://api.mysocialcode.com
    description: Production

tags:
  - name: Auth
    description: Phone OTP signup and authentication
  - name: Users
    description: User profile management and settings
  - name: Events
    description: Event creation, listing, and management
  - name: RSVP
    description: Join events and manage RSVPs
  - name: Check-in
    description: QR code validation and attendance tracking
  - name: Interests
    description: User interests and preferences
  - name: Business
    description: Business portal and management
  - name: Safety
    description: Reporting, blocking, and moderation
  - name: Admin
    description: Admin dashboard and moderation tools
  - name: System
    description: System health and status

# ============================
# üîê SECURITY SCHEMES
# ============================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token received after OTP verification

# ============================
# üì¶ SCHEMAS
# ============================
  schemas:
    User:
      type: object
      properties:
        user_id:
          type: string
          example: "usr_123abc"
        phone:
          type: string
          example: "+919876543210"
        name:
          type: string
          example: "John Doe"
        social_code:
          type: string
          example: "JOHN_2024"
        bio:
          type: string
          example: "Love meeting new people"
        profile_photo_url:
          type: string
          example: "https://s3.amazonaws.com/images/user123.jpg"
        date_of_birth:
          type: string
          format: date
        gender:
          type: string
          enum: [male, female, other, prefer_not_to_say]
        interests:
          type: array
          items:
            type: string
          example: ["social", "sports", "learning"]
        is_verified:
          type: boolean
        is_banned:
          type: boolean
        created_at:
          type: string
          format: date-time

    Event:
      type: object
      properties:
        event_id:
          type: string
          example: "evt_456xyz"
        title:
          type: string
          example: "Coffee & Conversation"
        description:
          type: string
          example: "Casual meetup for coffee lovers"
        date:
          type: string
          format: date
          example: "2025-01-25"
        time:
          type: string
          format: time
          example: "18:30"
        location_name:
          type: string
          example: "Brown Bean Cafe, Fort Kochi"
        latitude:
          type: number
          example: 10.2345
        longitude:
          type: number
          example: 76.5432
        capacity:
          type: integer
          example: 12
        current_attendees:
          type: integer
          example: 8
        category:
          type: string
          enum: [social, sports, learning, wellness, dining, arts]
          example: "social"
        status:
          type: string
          enum: [draft, published, closed, cancelled, completed]
          example: "published"
        is_public:
          type: boolean
          example: true
        women_only:
          type: boolean
          example: false
        requires_approval:
          type: boolean
          example: false
        image_url:
          type: string
          example: "https://s3.amazonaws.com/events/evt_456.jpg"
        host:
          type: object
          properties:
            user_id:
              type: string
            name:
              type: string
            social_code:
              type: string
        created_at:
          type: string
          format: date-time
        cancelled_at:
          type: string
          format: date-time
        cancellation_reason:
          type: string

    EventListItem:
      type: object
      properties:
        event_id:
          type: string
        title:
          type: string
        date:
          type: string
          format: date
        time:
          type: string
        location_name:
          type: string
        distance_km:
          type: number
        current_attendees:
          type: integer
        capacity:
          type: integer
        category:
          type: string
        image_url:
          type: string

    RSVP:
      type: object
      properties:
        rsvp_id:
          type: string
        user_id:
          type: string
        event_id:
          type: string
        status:
          type: string
          enum: [pending, approved, rejected, cancelled]
        guests_count:
          type: integer
        joined_at:
          type: string
          format: date-time

    EPass:
      type: object
      properties:
        epass_id:
          type: string
        qr_code:
          type: string
        is_used:
          type: boolean
        created_at:
          type: string
          format: date-time

    CheckIn:
      type: object
      properties:
        checkin_id:
          type: string
        user_id:
          type: string
        event_id:
          type: string
        checked_in_at:
          type: string
          format: date-time

    Interest:
      type: object
      properties:
        interest_id:
          type: string
        name:
          type: string
          example: "Social Events"
        icon:
          type: string

    Business:
      type: object
      properties:
        business_id:
          type: string
        user_id:
          type: string
        business_name:
          type: string
          example: "Brown Bean Cafe"
        phone:
          type: string
          example: "+919876543210"
        email:
          type: string
          example: "owner@browncafe.com"
        location_name:
          type: string
        latitude:
          type: number
        longitude:
          type: number
        description:
          type: string
        website:
          type: string
        is_verified:
          type: boolean
        commission_rate:
          type: number
        created_at:
          type: string
          format: date-time

    Report:
      type: object
      properties:
        report_id:
          type: string
        reporter_id:
          type: string
        reported_user_id:
          type: string
        event_id:
          type: string
        reason:
          type: string
          enum: [inappropriate_behavior, harassment, unsafe_venue, fake_profile, other]
        description:
          type: string
        status:
          type: string
          enum: [open, investigating, resolved, dismissed]
        created_at:
          type: string
          format: date-time

    Block:
      type: object
      properties:
        block_id:
          type: string
        blocker_id:
          type: string
        blocked_user_id:
          type: string
        created_at:
          type: string
          format: date-time

# ============================
# üîê AUTH ENDPOINTS
# ============================
paths:
/auth/register:
  post:
    tags: [Auth]
    summary: Register new user with profile and interests
    description: >
      Completes user registration after OTP verification.
      This endpoint creates the user profile and stores onboarding data.
    security: [{ BearerAuth: [] }]
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - name
              - interests
            properties:
              name:
                type: string
                example: "John Doe"
              social_code:
                type: string
                example: "JOHN_2024"
              bio:
                type: string
                example: "Love meeting new people"
              date_of_birth:
                type: string
                format: date
                example: "1995-08-21"
              gender:
                type: string
                enum: [male, female, other, prefer_not_to_say]
              interests:
                type: array
                minItems: 1
                items:
                  type: string
                example: ["social", "learning", "sports"]
              looking_for:
                type: string
                enum: [friends, networking, dating]
              profile_photo_url:
                type: string
                example: "https://s3.amazonaws.com/images/user123.jpg"
    responses:
      201:
        description: User registered successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                user:
                  $ref: '#/components/schemas/User'
                token:
                  type: string
      400:
        description: Invalid registration data
      401:
        description: OTP not verified


  /auth/signup:
    post:
      tags: [Auth]
      summary: Send OTP to phone number
      description: User enters phone, receives 6-digit OTP via SMS
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phone]
              properties:
                phone:
                  type: string
                  example: "+919876543210"
                  description: Phone number with country code
      responses:
        200:
          description: OTP sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                    example: "OTP sent to +919876543210"
                  request_id:
                    type: string
                    description: Use this for verification
        400:
          description: Invalid phone number
        429:
          description: Too many attempts, try again later

  /auth/verify:
    post:
      tags: [Auth]
      summary: Verify OTP and create/login user
      description: User enters OTP received on phone, returns JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phone, otp]
              properties:
                phone:
                  type: string
                  example: "+919876543210"
                otp:
                  type: string
                  example: "123456"
      responses:
        200:
          description: User verified, logged in successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
                    description: JWT token for authenticated requests
                    example: "eyJhbGciOiJIUzI1NiIs..."
                  is_new_user:
                    type: boolean
                    description: True if first time signup
        400:
          description: Invalid OTP or expired
        401:
          description: Verification failed

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout user
      security: [{ BearerAuth: [] }]
      responses:
        200:
          description: Logged out successfully

# ============================
# üë§ USER PROFILE ENDPOINTS
# ============================

  /users/me:
    get:
      tags: [Users]
      summary: Get current user profile
      security: [{ BearerAuth: [] }]
      responses:
        200:
          description: User profile retrieved
          content:
            application/json:
              schema:
                properties:
                  success:
                    type: boolean
                  user:
                    $ref: '#/components/schemas/User'
        401:
          description: Unauthorized

    put:
      tags: [Users]
      summary: Update user profile
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "John Doe"
                social_code:
                  type: string
                  example: "JOHN_2024"
                bio:
                  type: string
                  example: "Love meeting new people"
                profile_photo_url:
                  type: string
                  example: "https://s3.amazonaws.com/images/user123.jpg"
                date_of_birth:
                  type: string
                  format: date
                  example: "1990-01-15"
                gender:
                  type: string
                  enum: [male, female, other, prefer_not_to_say]
      responses:
        200:
          description: Profile updated
          content:
            application/json:
              schema:
                properties:
                  success:
                    type: boolean
                  user:
                    $ref: '#/components/schemas/User'
        400:
          description: Invalid data
        401:
          description: Unauthorized

    delete:
      tags: [Users]
      summary: Delete account
      security: [{ BearerAuth: [] }]
      description: Permanently delete user account and all associated data
      responses:
        200:
          description: Account deleted successfully
        401:
          description: Unauthorized

  /users/me/photo:
    post:
      tags: [Users]
      summary: Upload profile photo
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                photo:
                  type: string
                  format: binary
      responses:
        200:
          description: Photo uploaded
          content:
            application/json:
              schema:
                properties:
                  success:
                    type: boolean
                  photo_url:
                    type: string

  /users/me/settings:
    get:
      tags: [Users]
      summary: Get user settings
      security: [{ BearerAuth: [] }]
      responses:
        200:
          description: User settings
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  settings:
                    type: object
                    properties:
                      notifications_enabled:
                        type: boolean
                      email_notifications:
                        type: boolean
                      event_reminders:
                        type: boolean
                      show_profile:
                        type: boolean
                      allow_messages:
                        type: boolean

    put:
      tags: [Users]
      summary: Update user settings
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                notifications_enabled:
                  type: boolean
                email_notifications:
                  type: boolean
                event_reminders:
                  type: boolean
                show_profile:
                  type: boolean
                allow_messages:
                  type: boolean
      responses:
        200:
          description: Settings updated

# ============================
# üéØ INTERESTS ENDPOINTS
# ============================

  /interests:
    get:
      tags: [Interests]
      summary: List all available interests
      responses:
        200:
          description: List of interests
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  interests:
                    type: array
                    items:
                      $ref: '#/components/schemas/Interest'

  /users/me/interests:
    get:
      tags: [Interests]
      summary: Get my interests
      security: [{ BearerAuth: [] }]
      responses:
        200:
          description: User's selected interests
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  interests:
                    type: array
                    items:
                      type: string

    put:
      tags: [Interests]
      summary: Update my interests
      security: [{ BearerAuth: [] }]
      description: User can select multiple interests they're interested in
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [interests]
              properties:
                interests:
                  type: array
                  items:
                    type: string
                  example: ["social", "sports", "learning"]
      responses:
        200:
          description: Interests updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  interests:
                    type: array
                    items:
                      type: string

# ============================
# üìÖ EVENT ENDPOINTS
# ============================

  /events:
    get:
      tags: [Events]
      summary: List all events with filters
      description: Get paginated list of events, optionally filtered by date, location, category, interests
      parameters:
        - name: latitude
          in: query
          schema:
            type: number
            example: 10.2345
          description: User latitude for distance calculation
        - name: longitude
          in: query
          schema:
            type: number
            example: 76.5432
          description: User longitude for distance calculation
        - name: radius_km
          in: query
          schema:
            type: integer
            default: 10
            example: 5
          description: Search radius in kilometers
        - name: category
          in: query
          schema:
            type: string
            enum: [social, sports, learning, wellness, dining, arts]
            example: "social"
          description: Filter by category
        - name: date_from
          in: query
          schema:
            type: string
            format: date
            example: "2025-01-20"
          description: Filter events from this date
        - name: women_only
          in: query
          schema:
            type: boolean
            example: false
          description: Show women-only events
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        200:
          description: List of events
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/EventListItem'
                  total:
                    type: integer
                  page:
                    type: integer

    post:
      tags: [Events]
      summary: Create new event
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title, description, date, time, latitude, longitude, capacity, category]
              properties:
                title:
                  type: string
                  example: "Coffee & Conversation"
                description:
                  type: string
                  example: "Casual meetup for coffee lovers"
                date:
                  type: string
                  format: date
                  example: "2025-01-25"
                time:
                  type: string
                  format: time
                  example: "18:30"
                latitude:
                  type: number
                  example: 10.2345
                longitude:
                  type: number
                  example: 76.5432
                location_name:
                  type: string
                  example: "Brown Bean Cafe, Fort Kochi"
                capacity:
                  type: integer
                  example: 12
                category:
                  type: string
                  enum: [social, sports, learning, wellness, dining, arts]
                is_public:
                  type: boolean
                  default: true
                requires_approval:
                  type: boolean
                  default: false
                women_only:
                  type: boolean
                  default: false
                image_url:
                  type: string
                  example: "https://s3.amazonaws.com/events/event123.jpg"
      responses:
        201:
          description: Event created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  event:
                    $ref: '#/components/schemas/Event'
        400:
          description: Invalid event data
        401:
          description: Unauthorized

  /events/{event_id}:
    get:
      tags: [Events]
      summary: Get event details
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
            example: "evt_123abc"
      responses:
        200:
          description: Event details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Event'
        404:
          description: Event not found

    put:
      tags: [Events]
      summary: Update event
      security: [{ BearerAuth: [] }]
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                date:
                  type: string
                  format: date
                time:
                  type: string
                  format: time
                location_name:
                  type: string
                latitude:
                  type: number
                longitude:
                  type: number
                capacity:
                  type: integer
                image_url:
                  type: string
      responses:
        200:
          description: Event updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  event:
                    $ref: '#/components/schemas/Event'
        401:
          description: Only event host can update
        404:
          description: Event not found

    delete:
      tags: [Events]
      summary: Cancel/Delete event
      security: [{ BearerAuth: [] }]
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  example: "Host cancelled due to weather"
      responses:
        200:
          description: Event cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  event:
                    type: object
                    properties:
                      status:
                        type: string
                        example: "cancelled"
                      cancelled_at:
                        type: string
                        format: date-time
        401:
          description: Only event host can cancel
        404:
          description: Event not found

  /events/{event_id}/attendees:
    get:
      tags: [Events]
      summary: Get event attendees list
      security: [{ BearerAuth: [] }]
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: List of attendees
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  attendees:
                    type: array
                    items:
                      type: object
                      properties:
                        user_id:
                          type: string
                        name:
                          type: string
                        social_code:
                          type: string
                        rsvp_status:
                          type: string
                          enum: [pending, approved, rejected, cancelled]
                        joined_at:
                          type: string
                          format: date-time

  /users/me/events:
    get:
      tags: [Users]
      summary: Get events hosted by me
      security: [{ BearerAuth: [] }]
      responses:
        200:
          description: Hosted events
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/Event'

# ============================
# üôã RSVP ENDPOINTS
# ============================

  /events/{event_id}/rsvp:
    post:
      tags: [RSVP]
      summary: Join event (RSVP)
      security: [{ BearerAuth: [] }]
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                guests_count:
                  type: integer
                  default: 1
                  example: 1
      responses:
        201:
          description: Successfully joined event, e-pass generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  rsvp:
                    $ref: '#/components/schemas/RSVP'
                  e_pass:
                    $ref: '#/components/schemas/EPass'
        400:
          description: Event full, already joined, or capacity exceeded
        401:
          description: User not authenticated

    delete:
      tags: [RSVP]
      summary: Cancel RSVP
      security: [{ BearerAuth: [] }]
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: RSVP cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /events/{event_id}/rsvps:
    get:
      tags: [RSVP]
      summary: Get all RSVPs for event (host only)
      security: [{ BearerAuth: [] }]
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: List of RSVPs
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  rsvps:
                    type: array
                    items:
                      $ref: '#/components/schemas/RSVP'

  /events/{event_id}/rsvps/{rsvp_id}:
    patch:
      tags: [RSVP]
      summary: Approve or reject RSVP (host only)
      security: [{ BearerAuth: [] }]
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
        - name: rsvp_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [approved, rejected]
      responses:
        200:
          description: RSVP updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  rsvp:
                    $ref: '#/components/schemas/RSVP'

  /users/me/rsvps:
    get:
      tags: [Users]
      summary: Get events I joined
      security: [{ BearerAuth: [] }]
      responses:
        200:
          description: My RSVPs
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  rsvps:
                    type: array
                    items:
                      $ref: '#/components/schemas/RSVP'

# ============================
# üéüÔ∏è CHECK-IN ENDPOINTS
# ============================

  /check-in/validate:
    post:
      tags: [Check-in]
      summary: Validate QR code and check-in
      description: Scan QR e-pass and mark user as checked in. Always uses primary database for consistency.
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [qr_code]
              properties:
                qr_code:
                  type: string
                  example: "epass_abc123xyz789"
      responses:
        200:
          description: Check-in successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  attendee:
                    type: object
                    properties:
                      name:
                        type: string
                      social_code:
                        type: string
                      checked_in_at:
                        type: string
                        format: date-time
        400:
          description: Invalid QR, already checked in, or QR expired
        404:
          description: QR not found

  /check-in/event/{event_id}:
    get:
      tags: [Check-in]
      summary: Get checked-in attendees (host only)
      security: [{ BearerAuth: [] }]
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: List of checked-in attendees
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  checked_in:
                    type: array
                    items:
                      $ref: '#/components/schemas/CheckIn'
                  total:
                    type: integer

# ============================
# üè¢ BUSINESS ENDPOINTS
# ============================

  /business/signup:
    post:
      tags: [Business]
      summary: Register as business
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [business_name, email, location_name, latitude, longitude]
              properties:
                business_name:
                  type: string
                  example: "Brown Bean Cafe"
                email:
                  type: string
                  example: "owner@browncafe.com"
                location_name:
                  type: string
                  example: "Fort Kochi"
                latitude:
                  type: number
                longitude:
                  type: number
                description:
                  type: string
                  example: "Cozy cafe with great coffee"
                website:
                  type: string
                  example: "https://browncafe.com"
      responses:
        201:
          description: Business registered, pending verification
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  business:
                    $ref: '#/components/schemas/Business'

  /business/profile:
    get:
      tags: [Business]
      summary: Get my business profile
      security: [{ BearerAuth: [] }]
      responses:
        200:
          description: Business profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  business:
                    $ref: '#/components/schemas/Business'
        404:
          description: No business profile found

    put:
      tags: [Business]
      summary: Update business profile
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                business_name:
                  type: string
                description:
                  type: string
                website:
                  type: string
                location_name:
                  type: string
                latitude:
                  type: number
                longitude:
                  type: number
      responses:
        200:
          description: Profile updated

  /business/dashboard:
    get:
      tags: [Business]
      summary: Get business dashboard analytics
      security: [{ BearerAuth: [] }]
      parameters:
        - name: date_from
          in: query
          schema:
            type: string
            format: date
        - name: date_to